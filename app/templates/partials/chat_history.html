{% set state = namespace(last_user_message='') %}
{% if not messages %}
<div id="chat-empty-state" class="chat-empty-state mx-auto max-w-2xl rounded-2xl border border-slate-200/80 bg-white/90 p-6 text-center dark:border-slate-700 dark:bg-slate-900/80">
  <p class="text-base font-semibold text-slate-800 dark:text-slate-100">How can I help today?</p>
  <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">Ask about your uploaded files, request a plan, or generate a concise brief.</p>
</div>
{% endif %}

{% for item in messages %}
  {% if item.role == 'user' %}
    {% set state.last_user_message = item.content %}
    <div class="chat-row user-row">
      <div class="message-role-label">You</div>
      <article class="message-card message-bubble user-bubble rounded-3xl border border-brand-300 bg-brand-600 px-4 py-3 text-white shadow-sm">
        <p class="whitespace-pre-wrap text-sm leading-6">{{ item.content }}</p>
      </article>
    </div>
  {% elif item.role == 'assistant' %}
    <div class="chat-row assistant-row">
      <div class="message-role-label">AI</div>
      <article class="message-card message-bubble assistant-bubble rounded-3xl border border-slate-200 bg-white px-4 py-3 dark:border-slate-700 dark:bg-slate-900" data-assistant-message="true">
        <div class="assistant-content prose prose-sm max-w-none whitespace-pre-wrap leading-6 dark:prose-invert">{{ item.content }}</div>
        {% if item.citations %}
        <div class="mt-3 flex flex-wrap gap-2">
          {% for citation in item.citations %}
          <button type="button" class="rounded-md border border-brand-300 bg-white px-2 py-1 text-xs font-medium text-brand-700 hover:bg-brand-50 dark:border-brand-700 dark:bg-slate-900 dark:text-brand-300 dark:hover:bg-brand-900/20" onclick="window.retrievia.scrollToCitation('{{ citation.id }}')">[{{ citation.id }}] {{ citation.title }}</button>
          {% endfor %}
        </div>
        {% endif %}
        <div class="mt-3 flex items-center gap-2">
          <button type="button" class="js-copy-answer rounded-md border border-slate-300 px-2 py-1 text-xs hover:bg-slate-100 dark:border-slate-700 dark:hover:bg-slate-800">Copy</button>
          <button type="button" class="js-regenerate-answer rounded-md border border-slate-300 px-2 py-1 text-xs hover:bg-slate-100 dark:border-slate-700 dark:hover:bg-slate-800" data-user-message="{{ state.last_user_message|e }}" data-conversation-id="{{ conversation_id }}">Regenerate</button>
        </div>
      </article>
    </div>
  {% endif %}
{% endfor %}

<script>
  var conversationInput = document.getElementById("conversation-id");
  if (conversationInput) {
    conversationInput.value = "{{ conversation_id }}";
  }
  window.retrievia.updateSources({{ latest_sources|tojson }});
  window.retrievia.renderMarkdownIn(document.getElementById("chat-messages"));
  window.retrievia.scrollChatToBottom();
</script>
