{% extends "app/layout.html" %}
{% block app_content %}
<section class="chat-layout-grid grid gap-4 lg:grid-cols-[300px_minmax(0,1fr)] 2xl:grid-cols-[300px_minmax(0,1fr)_320px]">
  <aside class="chat-panel hidden p-3 lg:block">
    <div class="mb-3 flex items-center justify-between px-1">
      <h2 class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-500 dark:text-slate-400">Conversations</h2>
      <button type="button" class="inline-flex h-8 items-center rounded-lg border border-slate-300/80 bg-white px-3 text-xs font-semibold text-slate-700 transition hover:-translate-y-0.5 hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800" onclick="window.retrievia.createNewConversation()">New</button>
    </div>
    <div class="mb-3 px-1">
      <input id="conversation-search" type="search" class="w-full rounded-xl border-slate-300 bg-white text-sm dark:border-slate-700 dark:bg-slate-950" placeholder="Search conversations">
    </div>
    <div class="space-y-1" id="conversation-list"></div>
    <script id="seed-conversations" type="application/json">{{ conversation_items|tojson }}</script>
  </aside>

  <div class="chat-shell chat-panel">
    <header class="chat-header px-4 py-4 md:px-6">
      <div class="flex flex-wrap items-start justify-between gap-3">
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-brand-700 dark:text-brand-300">Retrievia Assistant</p>
          <h1 class="mt-1 text-xl font-semibold tracking-tight text-slate-900 dark:text-slate-100">Ask anything about your workspace</h1>
          <p class="mt-1 text-sm text-slate-600 dark:text-slate-300">Fast answers with grounded citations and clean markdown.</p>
        </div>
        <div class="flex items-center gap-2">
          <button type="button" class="inline-flex h-9 items-center rounded-xl border border-slate-300/80 bg-white px-3 text-xs font-semibold text-slate-700 transition hover:-translate-y-0.5 hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800" onclick="window.retrievia.createNewConversation()">New chat</button>
          <label class="inline-flex h-9 items-center gap-2 rounded-xl border border-slate-300/80 bg-white px-3 text-xs font-medium text-slate-700 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
            <input id="chat-stream-mode" type="checkbox" class="rounded border-slate-300 text-brand-600" checked>
            Stream mode
          </label>
        </div>
      </div>

      <div class="mt-3 lg:hidden">
        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400">
          Switch conversation
          <select id="conversation-switcher" class="mt-1 w-full rounded-xl border-slate-300 bg-white text-sm dark:border-slate-700 dark:bg-slate-950"></select>
        </label>
      </div>

      <div class="mt-4 grid gap-2 sm:grid-cols-3" id="quick-prompts">
        <button type="button" class="prompt-chip" data-prompt="Summarize key insights from our uploaded docs with citations.">Summarize docs</button>
        <button type="button" class="prompt-chip" data-prompt="List open risks and unresolved questions from the documentation.">Find risks</button>
        <button type="button" class="prompt-chip" data-prompt="Create an action plan for the next sprint based on the available context.">Action plan</button>
      </div>
    </header>

    <div id="chat-messages" class="chat-feed space-y-5 px-3 py-5 md:px-6">
      <div id="chat-empty-state" class="chat-empty-state mx-auto max-w-2xl rounded-2xl border border-slate-200/80 bg-white/90 p-6 text-center dark:border-slate-700 dark:bg-slate-900/80">
        <p class="text-base font-semibold text-slate-800 dark:text-slate-100">How can I help today?</p>
        <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">Ask about your uploaded files, request a plan, or generate a concise brief.</p>
      </div>
    </div>

    <form id="chat-form" class="chat-composer p-3 md:p-4" hx-post="/app/chat/send" hx-target="#chat-messages" hx-swap="beforeend" hx-indicator="#chat-loading-indicator">
      <input name="conversation_id" id="conversation-id" class="hidden">
      <input type="hidden" name="mode" id="chat-mode-input" value="stream">

      <div class="composer-shell rounded-2xl border border-slate-300/80 bg-white p-2 shadow-soft dark:border-slate-700 dark:bg-slate-950">
        <textarea id="chat-message-input" name="message" required rows="2" class="w-full resize-none border-0 bg-transparent p-2 text-[15px] leading-6 focus:ring-0" placeholder="Message Retrievia"></textarea>
        <div class="flex items-center justify-between gap-3 px-2 pb-1 pt-2">
          <div class="text-xs text-slate-500 dark:text-slate-400">
            <span>Enter to send</span>
            <span class="mx-1">-</span>
            <span>Shift+Enter for newline</span>
            <span class="mx-1">-</span>
            <span><span id="chat-message-count">0</span> chars</span>
          </div>
          <button class="send-button inline-flex items-center justify-center rounded-xl bg-brand-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-brand-500" type="submit" aria-label="Send chat message">
            <span id="chat-loading-indicator" class="htmx-indicator mr-2 inline-block h-4 w-4 animate-spin rounded-full border-2 border-white border-r-transparent"></span>
            Send
          </button>
          <button id="chat-stop-button" class="hidden inline-flex items-center justify-center rounded-xl border border-rose-300 bg-rose-50 px-4 py-2 text-sm font-semibold text-rose-700 transition hover:bg-rose-100 dark:border-rose-800 dark:bg-rose-950/40 dark:text-rose-200 dark:hover:bg-rose-900/45" type="button" aria-label="Stop generating">
            Stop
          </button>
        </div>
      </div>
    </form>
  </div>

  <aside class="chat-panel p-4 xl:col-span-2 2xl:col-span-1">
    <h2 class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-500 dark:text-slate-400">Sources</h2>
    <div id="sources-panel" class="mt-3 space-y-2 text-sm text-slate-700 dark:text-slate-300">
      <p class="text-slate-500 dark:text-slate-400">Citations appear here after each answer.</p>
    </div>
  </aside>
</section>
{% endblock %}
