{
  "info": {
    "_postman_id": "8dfb5cb0-2d8f-4cf9-9a7c-3f8f83a8d901",
    "name": "Retrievia Auth + Tenant Isolation",
    "description": "Auth and tenant-isolation API checks for Retrievia.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    { "key": "baseUrl", "value": "http://127.0.0.1:8000" },
    { "key": "tenantId", "value": "8ebdd570-d33c-456a-b802-559474bcc9b6" },
    { "key": "otherTenantId", "value": "948f3e95-e861-448c-8301-a5d4020066b0" },
    { "key": "email", "value": "admin@acme-test.local" },
    { "key": "password", "value": "ChangeMe12345!" },
    { "key": "registerEmail", "value": "" },
    { "key": "token", "value": "" }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "const baseUrl = pm.collectionVariables.get('baseUrl');",
          "if (!baseUrl) {",
          "  throw new Error('Missing collection variable: baseUrl');",
          "}",
          "const tenantId = pm.collectionVariables.get('tenantId');",
          "if (!tenantId) {",
          "  console.warn('tenantId is not set. Tenant-protected requests will fail.');",
          "}"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "pm.test('Response time < 2000ms', function () {",
          "  pm.expect(pm.response.responseTime).to.be.below(2000);",
          "});"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "System",
      "item": [
        {
          "name": "Healthz",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{baseUrl}}/healthz"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('healthz 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "const body = pm.response.json();",
                  "pm.test('healthz status ok', function () {",
                  "  pm.expect(body.status).to.eql('ok');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Readyz",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{baseUrl}}/readyz"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('readyz 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "const body = pm.response.json();",
                  "pm.test('readyz status ready', function () {",
                  "  pm.expect(body.status).to.eql('ready');",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Auth",
      "item": [
        {
          "name": "Register User",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "let registerEmail = pm.collectionVariables.get('registerEmail');",
                  "if (!registerEmail) {",
                  "  const suffix = Math.random().toString(36).slice(2, 10);",
                  "  registerEmail = `postman-${suffix}@example.local`;",
                  "  pm.collectionVariables.set('registerEmail', registerEmail);",
                  "}",
                  "pm.variables.set('effectiveRegisterEmail', registerEmail);"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const code = pm.response.code;",
                  "pm.test('register returns 201 or 409', function () {",
                  "  pm.expect([201, 409]).to.include(code);",
                  "});",
                  "if (code === 201) {",
                  "  const body = pm.response.json();",
                  "  pm.collectionVariables.set('email', body.email);",
                  "  pm.test('registered email persisted for login', function () {",
                  "    pm.expect(body.email).to.eql(pm.collectionVariables.get('effectiveRegisterEmail'));",
                  "  });",
                  "}",
                  "if (code === 409) {",
                  "  pm.test('duplicate blocked', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.detail).to.eql('email_already_exists');",
                  "  });",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "X-Tenant-Id", "value": "{{tenantId}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{effectiveRegisterEmail}}\",\n  \"password\": \"{{password}}\",\n  \"full_name\": \"Postman User\"\n}"
            },
            "url": "{{baseUrl}}/auth/register"
          }
        },
        {
          "name": "Login",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const registerEmail = pm.collectionVariables.get('registerEmail');",
                  "if (registerEmail) {",
                  "  pm.collectionVariables.set('email', registerEmail);",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('login 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "const body = pm.response.json();",
                  "pm.test('token present', function () {",
                  "  pm.expect(body.access_token).to.be.a('string').and.not.empty;",
                  "  pm.expect(body.token_type).to.eql('bearer');",
                  "});",
                  "pm.collectionVariables.set('token', body.access_token);"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              { "key": "X-Tenant-Id", "value": "{{tenantId}}" },
              { "key": "Content-Type", "value": "application/x-www-form-urlencoded" }
            ],
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                { "key": "username", "value": "{{email}}" },
                { "key": "password", "value": "{{password}}" }
              ]
            },
            "url": "{{baseUrl}}/auth/login"
          }
        },
        {
          "name": "Me",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('/auth/me 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "const body = pm.response.json();",
                  "pm.test('tenant id matches selected tenant', function () {",
                  "  pm.expect(body.tenant_id).to.eql(pm.collectionVariables.get('tenantId'));",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" },
              { "key": "X-Tenant-Id", "value": "{{tenantId}}" }
            ],
            "url": "{{baseUrl}}/auth/me"
          }
        },
        {
          "name": "Me (Tenant Header Mismatch -> 403)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('mismatch is forbidden', function () {",
                  "  pm.response.to.have.status(403);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" },
              { "key": "X-Tenant-Id", "value": "{{otherTenantId}}" }
            ],
            "url": "{{baseUrl}}/auth/me"
          }
        },
        {
          "name": "Login (Bad Password -> 401)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('bad password unauthorized', function () {",
                  "  pm.response.to.have.status(401);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              { "key": "X-Tenant-Id", "value": "{{tenantId}}" },
              { "key": "Content-Type", "value": "application/x-www-form-urlencoded" }
            ],
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                { "key": "username", "value": "{{email}}" },
                { "key": "password", "value": "wrong-password-value" }
              ]
            },
            "url": "{{baseUrl}}/auth/login"
          }
        }
      ]
    }
  ]
}
